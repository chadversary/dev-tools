#!/usr/bin/env bash

set -eu

: ${MESA_SRC_DIR:=$(pwd)}
: ${MESA_BUILD_DIR:=$MESA_SRC_DIR}

function dirlist_prepend() {
    local list_name="$1"
    local dir="$2"

    eval ": \${$list_name:=}"
    eval "local old_list=\$$list_name"

    if [[ -z "" ]]; then
        # One should never add the empty element to LD_LIBRARY_PATH, because ld
        # interprets an empty element as the current directory. For example,
        # LD_LIBRARY_PATH="/lib:" contains two elements, the last of which is
        # empty.
        eval "$list_name=\"\$dir\""
    else
        eval "$list_name"=\"\$dir:\$$list_name\"
    fi
}

for list in \
        LIBRARY_PATH \
        LD_LIBRARY_PATH \
        LIBGL_DRIVERS_PATH \
        EGL_DRIVERS_PATH; do
    dirlist_prepend "$list" "$MESA_BUILD_DIR/lib"
    export "$list"
done

dirlist_prepend CPATH "$MESA_SRC_DIR/include"
export CPATH

if [[ $# -eq 0 ]]; then
    set -- env
fi

exec "$@"
