#!/usr/bin/env bash

set -eu

: ${PREFIX:=}
: ${USE:=}
: ${MESA_SRC_DIR:=$(pwd)}
: ${MESA_BUILD_DIR:=$MESA_SRC_DIR}

use() {
    [[ ",${USE}," = *,$1,* ]]
}

use_enable() {
    local use_flag="$1"
    local enable_flag="$1"
    shift

    if [[ $# -ne 0 ]]; then
        enable_flag="$2"
        shift
    fi

    if [[ $# -ne 0 ]]; then
        die "trailing args: $@"
    fi

    if use "$use_flag"; then
        printf -- '--enable-%s\n' "$enable_flag"
    else
        printf -- '--disable-%s\n' "$enable_flag"
    fi
}

configure() {
    local configure_opts=(
        --enable-dri3
        --disable-gallium-egl
        --disable-osmesa
        --disable-vdpau
        --disable-xa
        --enable-dri
        --enable-egl
        --enable-gbm
        --enable-gles1
        --enable-gles2
        --enable-glx
        --enable-glx-tls
        --enable-shared-glapi
        --enable-texture-float
        --with-dri-drivers=i965
        --with-egl-platforms=x11,drm,wayland
        --with-gallium-drivers=
        $(use_enable debug)
    )

    if use debug; then
        configure_opts+=(
            "CFLAGS=-g3 -O0"
            "CXXFLAGS=-g3 -O0"
        )
    fi

    if [[ "$PREFIX" ]]; then
        configure_opts+=("--prefix=$PREFIX")
    fi

    if ! [[ -e "$MESA_SRC_DIR/configure" ]]; then
        (
            cd "$MESA_SRC_DIR"
            autoreconf -vfi
        )
    fi

    cd "$MESA_BUILD_DIR"
    "$MESA_SRC_DIR/configure" "${configure_opts[@]}" "$@"
}

configure "$@"
